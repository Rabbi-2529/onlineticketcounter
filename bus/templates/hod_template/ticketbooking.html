{% extends 'hod_template/base_template.html' %} 
{% load static %}

{% block custom_css %}
    <link rel="stylesheet" href="{% static "dist/css/ticket_booking.css" %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css">
{% endblock custom_css %}

{% block page_title %}
{% endblock page_title %}
{% block main_content %}


<div class="container-xl px-4 mt-4">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-md-12">
                <!-- general form elements -->
                <form action="{% url 'search_form' %}" method="get">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Book Ticket</h3>
                        </div>
                        <!-- /.card-header -->
                        
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="form-group">
                                <label for="start_point">Start Point</label>
                                <input type="text" name="start_point" id="start-point-input" class="form-control" placeholder="Enter Start Point">
                                <ul id="start-district-suggestions" class="district-suggestions"></ul>
                            </div>
                            <div class="form-group">
                                <label for="end_point">End Point</label>
                                <input type="text" name="end_point" id="end-point-input" class="form-control" placeholder="Enter End Point">
                                <ul id="end-district-suggestions" class="district-suggestions"></ul>
                            </div>
                            <div class="form-group">
                                <div style="text-align: left;">
                                    <label for="journey-date-input" style="color: black; font-size: 14px;">Date of Journey</label>
                                </div>
                                <div class="input-with-calendar">
                                    <input type="text" id="journey-date-input" class="form-control form-control-lg" name="journey_date" required placeholder="DD-MM-YYYY" onfocus="this.placeholder = ''" onblur="this.placeholder = 'DD-MM-YYYY'"  />
                                    <i class="fas fa-calendar input-prefix small-calendar-icon" id="journey-date-icon"></i>
                                </div>
                            </div>
                            <div class="card-btn d-flex justify-content-center">
                                <button type="submit" class="btn btn-primary save-btn" onclick="saveFormData()">Search</button>
                            </div>
                        </div>
                            
                            <br>
                         

                    </div>

                    {% comment %} <div class="card card-primary">
                        <div class="card-body">
                            {% if bus_data %}
                            <table id="trips" class="tablesorter tablesorter-default" style=" width: 100%;">
                                <thead style="border-bottom: 5px solid #F7F7F7; color: #828282;">
                                    <tr>
                                        <th class="tbl_th1 th_text_color header">
                                            Operator <span style="font-weight: normal; margin-left: 5px;">(Bus Type)</span>
                                        </th>
                                        <th class="tbl_th3 header" style="color: #828282;">
                                            Dep. Time
                                        </th>
                                        <th class="tbl_th4 header" style="color: #828282;">
                                            Arr. Time
                                        </th>
                                        <th class="tbl_th5 header" style="color: #828282;">
                                            Seats Available
                                        </th>
                                        <th class="tbl_th6 header" style="color: #828282;">
                                            Fare
                                        </th> 
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bus in  bus_data %}
                                    <tr id="trip10230489" class="trip-row" data-trip="">
                                        <td class="tbl_col1 border-fix-seat" data-title="Operator">
                                            <ul>
                                                <li class="op_name shohoz_green"></li>
                                                <li class="bus_type" style="margin-bottom: 5px;">
                                                    <br>
                                                    <span class="trip_num" style="display:inline-block;padding: 0px 5px;border: 1px solid #a5a3a3; color: #868282;border-radius: 4px;background:#efefef;margin-left: 5px;">Coach: {{bus.coach_number}}</span>
                                                </li>
                        
                                                <li class="bus_type" style="margin-bottom: 5px;">{{bus.coach_model_name}},{{bus.coach_type}}</li>
                                                <li class="bus_type"><b style="color:#757A7E;">Route:</b> {{bus.routes}}</li>
                                                <li><b style="color:#757A7E;">Starting Point:</b> {{bus.start_point}}</li>
                                                <li><b style="color:#757A7E;">Ending Point:</b> {{bus.end_point}}</li>
                                            </ul>
                                        </td>
                                        <td class="tbl_col3 border-fix-seat" data-title="Dep. Time">{{bus.departure_time}}</td>
                                        <td class="tbl_col4 border-fix-seat" data-title="Arr. Time">{{ bus.arrival_time }}</td>
                                        <td class="tbl_col5 border-fix-seat" data-title="Seats Available">{{ bus.remaining_seats }}</td>
                                        <td class="tbl_col6 border-fix-seat" data-title="Fare">
                                            <h3 class="search_price__lHdmm search_purple__ypyVN">{{bus.price}} Tk</h3>
                                        </td>
                                        <td>
                                            <ul>
                                                <ul>
                                                    <li class="seats-button">
                                                        <a href="#" class="btn btn-default btn-sm btnSubmit seatsLayout bg-success view-seats-button" data-bus-number="{{ bus.bus_number }}" data-coach-number="{{ bus.coach_number }}" data-bus-price="{{ bus.price }}" data-journey-date="{{ journey_date }}" data-route="{{ bus.routes.id }}" data-start-point="{{bus.start_point}}" data-end-point="{{bus.end_point}}">
                                                            View Seats
                        
                                                            <div class="view-seats-spinner"></div>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </ul>
                                        </td>
                                    </tr>
                                    <td id="tbl_offer" colspan="6" style="border-bottom: 15px solid #f7f7f7;">
                                        
                                    </td>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="alert alert-danger alert-dismissible fade show" style="margin-left: 20px; margin-right: 20px;">
                                Sorry, No Buses Available Now.
                            </div>
                            {% endif %}
                            
                        </div>
                    </div> {% endcomment %}

                    
                        {% if bus_data %}
                            {% for bus in bus_data %}
                            <div class="card card-primary">
                                <div class="card-header d-flex justify-content-center">
                                    <h3 class="card-title" data-title="Operator">{{ bus.coach_model_name }},{{ bus.coach_type }} ({{bus.coach_number}}): {{ journey_date }}</h3>
                                </div>
                                <div class="row card-body">

                                    <div class="bus-info-div col-lg-3 col-md-3 col-6 mb-4">
                                        <div class="row bus-info-row justify-content-center">
                                            <p><span class="bus-info-heading">Route</span></p>
                                            <p class="" ><span class="bus-info-text">{{ bus.start_point }} to {{ bus.end_point }}</span></p>
                                        </div>
                                    </div>

                                    <div class="bus-info-div col-lg-3 col-md-3 col-6 mb-4">
                                        <div class="row bus-info-row justify-content-center">
                                            <p data-title="Dep. Time"><span class="bus-info-heading">Departure Time</span></p>
                                            <p class=""><span class="bus-info-text">{{ bus.departure_time }}</span></p>
                                            <p ><span class="bus-info-heading">Departure Time</span></p>
                                            <p class="" data-title="Arr. Time"><span class="bus-info-text">{{ bus.arrival_time }}</span></p>
                                        </div>
                                    </div>

                                    <div class="bus-info-div col-lg-3 col-md-3 col-6 mb-4">
                                        <div class="row bus-info-row justify-content-center">
                                            <p><span class="bus-info-heading">Available Seats</span></p>
                                            <p class="" data-title="Seats Available"><span class="bus-info-text">{{ bus.remaining_seats }}</span></p>
                                        </div>
                                    </div>

                                    <div class="bus-info-div col-lg-3 col-md-3 col-6 mb-4">
                                        <div class="row bus-info-row justify-content-center">
                                            <p><span class="bus-info-heading">Fare</span></p>
                                            <p class="" data-title="Fare"><span class="bus-info-text">{{bus.price}} Tk</span></p>
                                        </div>
                                    </div>

                                </div>
                                <div class="d-flex justify-content-center mb-4">
                                    <a href="#" class="btn btn-default btn-sm btnSubmit seatsLayout view-seats-button save-btn" data-bus-number="{{ bus.bus_number }}" data-coach-number="{{ bus.coach_number }}" data-bus-price="{{ bus.price }}" data-journey-date="{{ journey_date }}" data-route="{{ bus.routes.id }}" data-start-point="{{bus.start_point}}" data-end-point="{{bus.end_point}}">
                                        View Seats
                                        <div class="view-seats-spinner"></div>
                                    </a>
                                
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    
                </form>
                <!-- /.card -->
            </div>
        </div>
    </div>
</div>
<div class="popup" id="myPopup" >
    <div class="popup-content">
        <span class="close">&times;</span>
    </div>
</div> 
{% endblock main_content %} {% block custom_js %} 


<script>
document.addEventListener("DOMContentLoaded", function () {
    var viewSeatsButtons = document.querySelectorAll(".view-seats-button");
    var busPrice;
    var selectedSeats = [];
    var bookedSeats = Array.from('{{ booked_seats|escapejs }}');
    var maxSeats = 20;
    
    viewSeatsButtons.forEach(function (button) {
        button.addEventListener("click", function (event) {
            event.preventDefault();
    
            var busNumber = this.getAttribute("data-bus-number");
            var coachNumber = this.getAttribute("data-coach-number");
            var journeyDate = this.getAttribute("data-journey-date");
            var routeId = parseInt(this.getAttribute("data-route"))
            var startPoint = this.getAttribute("data-start-point");
            var endPoint = this.getAttribute("data-end-point");

            console.log('routeId: ', routeId);
            console.log('journey date: ' + JSON.stringify(journeyDate));
            busPrice = parseFloat(this.getAttribute("data-bus-price"));
    
            var popupUrl = "/popupseathod/" + busNumber + "/" + coachNumber + "/" + journeyDate + "/" + routeId + "/" + startPoint + "/" + endPoint + "/";

            fetch(popupUrl)
            .then(function (response) {
                return response.text();
            })
            .then(function (content) {
                
                var popupContent = document.querySelector(".popup-content");
                popupContent.innerHTML = content;

                var countdownElement = popupContent.querySelector('#countdown');
                var popup = document.getElementById("myPopup");
                popup.style.display = "block";

                console.log('popupContent: ', popupContent)
                console.log('timer popup: ', countdownElement)

                
    
                var seats = document.getElementsByClassName("seat-select");

                
                for (var i = 0; i < seats.length; i++) {
                    seats[i].addEventListener("mouseover", function () {
                    if (!this.classList.contains("booked-seat") && !this.classList.contains("selected")) {
                        this.nextElementSibling.style.transform = "scale(1)";
                        this.style.color = "rgb(22, 206, 53)";
                    }
                    });
    
                    seats[i].addEventListener("mouseout", function () {
                    if (!this.classList.contains("booked-seat")) {
                        if (this.classList.contains("selected")) {
                        this.nextElementSibling.style.transform = "scale(1)";
                        this.style.color = "rgb(22, 206, 53)";
                        } else {
                        this.nextElementSibling.style.transform = "scale(0)";
                        this.style.color = "";
                        }
                    }
                    });
    
                    seats[i].addEventListener("click", toggleSeat);
                }
    
                function toggleSeat() {
                    if (this.classList.contains("booked-seat")) {
                        return;
                    }
    
                    if (this.classList.contains("selected")) {
                        this.classList.remove("selected");
        
                        var rowId = document.getElementById("seat-" + this.id);
                        if (rowId) {
                            rowId.remove();
                        }
        
                        var index = selectedSeats.indexOf(this.id);
                        if (index !== -1) {
                        selectedSeats.splice(index, 1);
                        }
                    }
                    else {
                        if (selectedSeats.length < maxSeats) {
                        this.classList.add("selected");
        
                        var tableBody = document.getElementById("seat-view-table");
                        var seatNumber = this.id;
        
                        var newRow = document.createElement("tr");
                        newRow.id = "seat-" + this.id;
        
                        var cell1 = document.createElement("td");
                        cell1.classList.add("col-4");
                        cell1.textContent = seatNumber;
                        newRow.appendChild(cell1);
        
                        var cell2 = document.createElement("td");
                        cell2.classList.add("col-4", "ps-2");
                        cell2.textContent = busPrice;
                        newRow.appendChild(cell2);
        
                        var cell3 = document.createElement("td");
                        cell3.classList.add("col-4", "ps-4");
                        cell3.textContent = "First Class";
                        newRow.appendChild(cell3);
        
                        var cell4 = document.createElement("td");
                        cell4.classList.add("col-md-1");
                        var boldText = document.createElement("b");
                        boldText.textContent = seatNumber;
                        cell4.appendChild(boldText);
                        newRow.appendChild(cell4);
        
                        tableBody.appendChild(newRow);
                        console.log('Id: ', this.id)
        
                        selectedSeats.push(this.id);
                        }
                        else {
                            console.log("Maximum seat selection reached.");
                        }
                    }
    
                    for (var i = 0; i < seats.length; i++) {
                        if (seats[i].classList.contains("selected")) {
                            seats[i].nextElementSibling.style.transform = "scale(1)";
                        } else if (seats[i].classList.contains("booked-seat")) {
                            seats[i].nextElementSibling.style.transform = "scale(1)";
                        } else {
                            seats[i].nextElementSibling.style.transform = "scale(0)";
                        }
                    }
    
                    var cell2Values = [];
                    var cell2Elements = tableBody.querySelectorAll("td:nth-child(2)");
                    var totalAmount = 0;
    
                    for (var i = 0; i < cell2Elements.length; i++) {
                        var cell2Value = parseFloat(cell2Elements[i].textContent);
                        totalAmount += cell2Value;
                    }
    
                    var totalFare = document.getElementById("total-fare");
                    totalFare.textContent = totalAmount.toFixed(2);
                }

                // Get the popup and popup content elements
                
                console.log('popup check: ', popup)
                console.log('popup content: ', popupContent)
                console.log('popup content: ', countdownElement)

                var popUp = $('.popup')
                var popupContent = $('.popup-content')
                //var popupContent = $('.popup-content');
                console.log('popup check: ', popUp)
                var closeBtn = $('#close-btn')
                console.log('close-btn check: ', closeBtn)
                closeBtn.on('click', function () {
                    popUp.hide();
                    console.log('Popup closed');

                    clearInterval(timerInterval); // Clear the existing interval
                    timePassed = 0; // Reset time variables
                    timeLeft = TIME_LIMIT;

                    document.getElementById('base-timer-label').innerHTML = formatTime(timeLeft); // Update timer display


                    document.getElementById('base-timer-path-remaining').classList.remove(COLOR_CODES.warning.color);
                    document.getElementById('base-timer-path-remaining').classList.remove(COLOR_CODES.alert.color);
                    document.getElementById('base-timer-path-remaining').classList.add(COLOR_CODES.info.color);

                    // Start the timer again
                    startTimer();
                });
                

                // Add a click event listener to the entire document
                $(document).on('click', function (event) {
                    // Check if the clicked element is NOT inside the popup-content
                    if (!popupContent.has(event.target).length && !popupContent.is(event.target)) {
                        // Hide the popup
                        popUp.hide()
                        console.log('Clicked outside the popup');

                        clearInterval(timerInterval); // Clear the existing interval
                        timePassed = 0; // Reset time variables
                        timeLeft = TIME_LIMIT;

                        document.getElementById('base-timer-label').innerHTML = formatTime(timeLeft); // Update timer display

                        document.getElementById('base-timer-path-remaining').classList.remove(COLOR_CODES.warning.color);
                        document.getElementById('base-timer-path-remaining').classList.remove(COLOR_CODES.alert.color);
                        document.getElementById('base-timer-path-remaining').classList.add(COLOR_CODES.info.color);

                        // Start the timer again
                        startTimer();
                    }
                });
    
                var continueBtn = document.getElementById("booking-process");
    
                function bookingProcess() {
                    alert("Seat Selection Successful");
    
                    var selectedSeatNumber = selectedSeats.join(" ");
                    var selectedSeatPrice = parseFloat(busPrice) * selectedSeats.length;
    
                    var journeyDate = "{{ journey_date }}"; // Replace with the actual journey date value
                    console.log('journeyDate: ', journeyDate)
                    var routeId = "{{ route_id }}"; // Replace with the actual route id value
                    var selectedBoardingPoint = document.getElementById("boardingpoint").value; // Get the selected boarding point
    
                    continueBtn.href = continueBtn.href + "?seat=" + selectedSeatNumber + "&price=" + selectedSeatPrice + "&journey_date=" + journeyDate + "&route_id=" + routeId + "&boarding_point=" + selectedBoardingPoint + "&start_point=" + startPoint + "&end_point=" +
                    endPoint; // Append selected boarding point to the URL
    
                    for (var i = 0; i < seats.length; i++) {
                        if (seats[i].classList.contains("selected")) {
                            seats[i].classList.remove("selected");
                            seats[i].classList.add("booked-seat");
                            seats[i].style.color = "rgb(230, 94, 94)";
                            seats[i].style.cursor = "default";
                            seats[i].style.pointerEvents = "none";
                        }
                    }
                }
                continueBtn.addEventListener("click", bookingProcess);
    
                for (var i = 0; i < seats.length; i++) {
                    if (bookedSeats.includes(seats[i].id)) {
                        seats[i].classList.add("booked-seat");
                        seats[i].style.color = "rgb(230, 94, 94)";
                        seats[i].style.cursor = "default";
                        seats[i].style.pointerEvents = "none";
                    }
                }

                const FULL_DASH_ARRAY = 283;
                const WARNING_THRESHOLD = 30;
                const ALERT_THRESHOLD = 15;

                const COLOR_CODES = {
                info: {
                    color: "green"
                },
                warning: {
                    color: "orange",
                    threshold: WARNING_THRESHOLD
                },
                alert: {
                    color: "red",
                    threshold: ALERT_THRESHOLD
                }
                };

                
                const TIME_LIMIT = parseInt('{{ popup_duration_minutes }}');
                let timePassed = 0;
                let timeLeft = TIME_LIMIT;
                let timerInterval = null;
                let remainingPathColor = COLOR_CODES.info.color;

                countdownElement.innerHTML = `
                <div class="base-timer">
                <svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g class="base-timer__circle">
                    <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45"></circle>
                    <path
                        id="base-timer-path-remaining"
                        stroke-dasharray="283"
                        class="base-timer__path-remaining ${remainingPathColor}"
                        d="
                        M 50, 50
                        m -45, 0
                        a 45,45 0 1,0 90,0
                        a 45,45 0 1,0 -90,0
                        "
                    ></path>
                    </g>
                </svg>
                <span id="base-timer-label" class="base-timer__label">${formatTime(
                    timeLeft
                )}</span>
                </div>
                `;

                startTimer();

                function onTimesUp() {
                clearInterval(timerInterval);
                }

                function startTimer() {
                timerInterval = setInterval(() => {
                    timePassed = timePassed += 1;
                    timeLeft = TIME_LIMIT - timePassed;
                    document.getElementById("base-timer-label").innerHTML = formatTime(
                    timeLeft
                    );
                    setCircleDasharray();
                    setRemainingPathColor(timeLeft);

                    if (timeLeft === 0) {
                        onTimesUp();
                        popup.style.display = 'none';
                    }
                }, 1000);
                }

                function formatTime(time) {
                const minutes = Math.floor(time / 60);
                let seconds = time % 60;

                if (seconds < 10) {
                    seconds = `0${seconds}`;
                }

                return `${minutes}:${seconds}`;
                }

                function setRemainingPathColor(timeLeft) {
                const { alert, warning, info } = COLOR_CODES;
                if (timeLeft <= alert.threshold) {
                    document
                    .getElementById("base-timer-path-remaining")
                    .classList.remove(warning.color);
                    document
                    .getElementById("base-timer-path-remaining")
                    .classList.add(alert.color);
                } else if (timeLeft <= warning.threshold) {
                    document
                    .getElementById("base-timer-path-remaining")
                    .classList.remove(info.color);
                    document
                    .getElementById("base-timer-path-remaining")
                    .classList.add(warning.color);
                }
                }

                function calculateTimeFraction() {
                const rawTimeFraction = timeLeft / TIME_LIMIT;
                return rawTimeFraction - (1 / TIME_LIMIT) * (1 - rawTimeFraction);
                }

                function setCircleDasharray() {
                const circleDasharray = `${(
                    calculateTimeFraction() * FULL_DASH_ARRAY
                ).toFixed(0)} 283`;
                document
                    .getElementById("base-timer-path-remaining")
                    .setAttribute("stroke-dasharray", circleDasharray);
                }

            })
            
            .catch(function (error) {
                console.log("Error fetching popup content: ", error);
            });
        });
    });

});
</script>


{% comment %} <script>
$(function() {
    $("#journey-date-input").datepicker({
    dateFormat: 'dd-mm-yy',
    showOn: "button",
    buttonText: "<i class='fas fa-calendar'></i>",
    buttonImageOnly: true,
    buttonImage: "",
    });
});
</script> {% endcomment %}
<script>
var today = new Date();

// Format the date as dd-mm-yyyy
var dd = String(today.getDate()).padStart(2, "0");
var mm = String(today.getMonth() + 1).padStart(2, "0"); // January is 0!
var yyyy = today.getFullYear();

today = dd + "-" + mm + "-" + yyyy;

// Set the value for the date input field
document.getElementById("journey-date-input").value = today;

// Helper function to format the date as dd-mm-yyyy


// Set minimum selectable date as today

document.getElementById("start-point-input").addEventListener("input", function() {
    suggestDistrict(this);
});

document.getElementById("start-point-input").addEventListener("input", function() {
    suggestDistrict(this);
});

// Event listener for "From" input field click
document.getElementById("start-point-input").addEventListener("click", function() {
    this.style.borderColor = "blue"; // Change the border color to red
});

// Event listener for "From" input field blur
document.getElementById("start-point-input").addEventListener("blur", function() {
    this.style.borderColor = ""; // Reset the border color
});

// Event listener for "To" input field click
document.getElementById("end-point-input").addEventListener("click", function() {
    this.style.borderColor = "blue"; // Change the border color to blue
});

// Event listener for "To" input field blur
document.getElementById("end-point-input").addEventListener("blur", function() {
    this.style.borderColor = ""; // Reset the border color
});
</script>



<script>
let selectedDistrictIndex = -1; // Index of the currently selected suggestion

// Function to fetch JSON data from a file
async function fetchJsonData() {
    try {
        const response = await fetch('/static/json/districts.json'); // Adjust the path to your JSON file

        if (!response.ok) {
            throw new Error('Failed to fetch JSON data');
        }

        const jsonData = await response.json();
        return jsonData.districts.map(district => district.name);
    } catch (error) {
        console.error('Error fetching JSON data:', error);
        return [];
    }
}

// Function to suggest district names based on the input value
async function suggestDistrict(input) {
    const inputValue = input.value.toLowerCase();
    const otherInput = input.id === "start-point-input" ? document.getElementById("end-point-input") : document.getElementById("start-point-input");
    const districtList = input.id === "start-point-input" ? document.getElementById("start-district-suggestions") : document.getElementById("end-district-suggestions");

    districtList.innerHTML = '';

    const districtNames = await fetchJsonData();

    if (!districtNames || districtNames.length === 0) {
        console.error('No district names found in JSON data');
        return;
    }

    let count = 0;
    for (let i = 0; i < districtNames.length; i++) {
        const district = districtNames[i].toLowerCase();

        if (district.startsWith(inputValue) && district !== otherInput.value.toLowerCase() && district !== inputValue && count < 5) {
            const districtItem = document.createElement("li");
            districtItem.textContent = districtNames[i];
            districtItem.classList.add("district-item");

            districtItem.onclick = function () {
                input.value = districtNames[i];
                districtList.style.display = "none";
            };

            districtList.appendChild(districtItem);
            count++;
        }
    }

    if (districtList.childNodes.length > 0) {
        districtList.style.display = "block";
    } else {
        districtList.style.display = "none";
    }
}
// Event listener for input field value change
document.getElementById("start-point-input").addEventListener("input", function() {
    suggestDistrict(this);
});

document.getElementById("end-point-input").addEventListener("input", function() {
    suggestDistrict(this);
});

// Event listener for Enter key press in the input fields
document.getElementById("start-point-input").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        event.preventDefault(); // Prevent form submission
        selectSuggestion(this);
    }
});

document.getElementById("end-point-input").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        event.preventDefault(); // Prevent form submission
        selectSuggestion(this);
    }
});

// Function to select a suggestion
function selectSuggestion(input) {
    const inputValue = input.value.toLowerCase();
    const districtList = input.id === "start-point-input" ? document.getElementById("start-district-suggestions") : document.getElementById("end-district-suggestions");
    const suggestions = districtList.getElementsByTagName("li");

    if (selectedDistrictIndex > -1 && selectedDistrictIndex < suggestions.length) {
        const selectedSuggestion = suggestions[selectedDistrictIndex];
        input.value = selectedSuggestion.textContent;
        districtList.style.display = "none";
        selectedDistrictIndex = -1; // Reset the selected index
    }
}

// Event listener for mouseover on suggestion items
document.addEventListener("mouseover", function(event) {
    const target = event.target;
    if (target.tagName.toLowerCase() === "li" && (target.parentNode.id === "start-district-suggestions" || target.parentNode.id === "end-district-suggestions")) {
        target.classList.add("hovered");
    }
});

// Event listener for mouseout from suggestion items
document.addEventListener("mouseout", function(event) {
    const target = event.target;
    if (target.tagName.toLowerCase() === "li" && (target.parentNode.id === "start-district-suggestions" || target.parentNode.id === "end-district-suggestions")) {
        target.classList.remove("hovered");
    }
});

document.addEventListener("keydown", function(event) {
    const startDistrictList = document.getElementById("start-district-suggestions");
    const endDistrictList = document.getElementById("end-district-suggestions");

    if (startDistrictList.style.display === "block" || endDistrictList.style.display === "block") {
        const suggestions = startDistrictList.style.display === "block" ? startDistrictList.getElementsByTagName("li") : endDistrictList.getElementsByTagName("li");
        const numSuggestions = suggestions.length;

        if (event.key === "ArrowUp") {
            event.preventDefault(); // Prevent scrolling on arrow key press
            selectedDistrictIndex = (selectedDistrictIndex - 1 + numSuggestions) % numSuggestions;
        } else if (event.key === "ArrowDown") {
            event.preventDefault(); // Prevent scrolling on arrow key press
            selectedDistrictIndex = (selectedDistrictIndex + 1) % numSuggestions;
        }

        for (let i = 0; i < numSuggestions; i++) {
            suggestions[i].classList.remove("selected");
        }

        if (selectedDistrictIndex > -1 && selectedDistrictIndex < numSuggestions) {
            suggestions[selectedDistrictIndex].classList.add("selected");
        }
    }
});

// Check if the JSON file is loaded properly
fetchJsonData().then(districtNames => {
    if (!districtNames || districtNames.length === 0) {
        console.error('JSON file is not loaded properly');
    } else {
        console.log('JSON file is loaded successfully');
    }
});
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script>
$(document).ready(function() {
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, "0");
    var mm = String(today.getMonth() + 1).padStart(2, "0");
    var yyyy = today.getFullYear();
    today = dd + "-" + mm + "-" + yyyy;

    $("#journey-date-input").datepicker({
    dateFormat: "dd-mm-yy",
    minDate: today
    });

    $("#journey-date-icon").click(function() {
    $("#journey-date-input").datepicker("show");
    });
});
</script>
<script>
$(document).ready(function() {
    $("#journey-date-input").datepicker({
    dateFormat: "dd-mm-yy",
    showOn: "button",
    buttonText: "<i class='fas fa-calendar'></i>",
    buttonImageOnly: true,
    buttonImage: "",
    beforeShow: function(input, inst) {
        setTimeout(function() {
        inst.dpDiv.css({
            top: input.offsetTop + input.offsetHeight,
            left: input.offsetLeft
        });
        }, 0);
    }
    }).on("keydown paste", function(e) {
    e.preventDefault();
    });

    $("#journey-date-icon").click(function() {
    $("#journey-date-input").datepicker("show");
    });
});
</script>







<script>
$(document).ready(function() {
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, "0");
    var mm = String(today.getMonth() + 1).padStart(2, "0");
    var yyyy = today.getFullYear();
    today = dd + "-" + mm + "-" + yyyy;

    $("#return-date-input").datepicker({
    dateFormat: "dd-mm-yy",
    minDate: today
    });

    $("#return-date-icon").click(function() {
    $("#return-date-input").datepicker("show");
    });
});
</script>
<script>
$(document).ready(function() {
    $("#return-date-input").datepicker({
    dateFormat: "dd-mm-yy",
    showOn: "button",
    buttonText: "<i class='fas fa-calendar'></i>",
    buttonImageOnly: true,
    buttonImage: "",
    beforeShow: function(input, inst) {
        setTimeout(function() {
        inst.dpDiv.css({
            top: input.offsetTop + input.offsetHeight,
            left: input.offsetLeft
        });
        }, 0);
    }
    }).on("keydown paste", function(e) {
    e.preventDefault();
    });

    $("#return-date-icon").click(function() {
    $("#return-date-input").datepicker("show");
    });
});
</script>












<script>
function validateForm() {
    var startCity = document.getElementById("start-point-input").value;
    var endCity = document.getElementById("end-point-input").value;
    var errorMessage = document.getElementById("error-message");

    if (startCity === endCity) {
    errorMessage.style.display = "block";
    document.getElementById("end-point-input").classList.add("is-invalid");
    } else {
    errorMessage.style.display = "none";
    document.getElementById("end-point-input").classList.remove("is-invalid");
    document.getElementById("search-form").submit();
    }
}

// Add an event listener to the input fields to remove the danger styling and hide the error message when clicked
document.getElementById("start-point-input").addEventListener("click", function () {
    document.getElementById("error-message").style.display = "none";
    document.getElementById("end-point-input").classList.remove("is-invalid");
});

document.getElementById("end-point-input").addEventListener("click", function () {
    document.getElementById("error-message").style.display = "none";
    document.getElementById("end-point-input").classList.remove("is-invalid");
});
</script>


<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js"></script>
{% endblock custom_js %}