{% extends 'inventory_templates/inventory_base.html' %}
{% load static %}

{% block custom_css %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script> <!-- Optional for sweet alerts -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="{% static "dist/css/add_product.css" %}">

<style>
    /* Custom status colors */
    .custom-status-pending {
        color: orange; /* Adjust the color as needed */
    }

    .custom-status-received {
        color: green; /* Adjust the color as needed */
    }

    .custom-status-completed {
        color: blue; /* Adjust the color as needed */
    }

    .custom-status-canceled {
        color: red; /* Adjust the color as needed */
    }
    .make-payment-link,
    .view-payment-link{
        color: black !important;
    }
    .delete-purchase {
        color: black !important;
    }
    .btn-btn-light {
        border-color: black;
      }
      .btn-btn-light {
        border-color: black;
        color: black; /* Set the default text color */
        transition: border-color 0.4s, color 0.4s; /* Add a smooth transition for the color change */
      }
      
      .btn-btn-light:hover {
        border-color: blue;
        color: blue; /* Change the text color to blue on hover */
      }

    .modal {
        display: none;
        position: fixedre;
        top: 0;
        left: 0;
        z-index: 1050;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-body{
        width: 670px;
    }
    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        
        width: 690px;
        position: relative;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    }
    

    
    /* CSS */
    .custom-btn {
      background-color: #EA4C89 !important;
      border-radius: 8px;
      border-style: none;
      box-sizing: border-box;
      color: #FFFFFF !important;
      cursor: pointer;
      display: inline-block;
      font-family: "Haas Grot Text R Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 14px;
      font-weight: 500;
      height: 40px;
      line-height: 20px;
      list-style: none;
      margin: 0;
      outline: none;
      padding: 10px 16px;
      position: relative;
      text-align: center;
      text-decoration: none;
      transition: color 100ms;
      vertical-align: baseline;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    
    .custom-btn:hover,
    .custom-btn:focus {
        background-color: #F082AC !important;
    }
    


    

    
</style>
{% endblock custom_css %}

{% block main_content %}

<div class="container-xl px-4 mt-4">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header d-flex justify-content-center">
                        <h3 class="card-title py-2">Company List</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <div class="add-staff-type-button col-md-6 col-12 mb-2">
                                <a href="{% url 'add_purchase' %}" class="btn btn-success save-btn">Add Purchase</a>
                            </div>
                            <table id="paydetaillist" class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>SL</th>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                        <th>Warehouse</th>
                                        <th>Status</th>
                                        <th>Payment Status</th> <!-- New Payment Status Column -->
                                        <th>Grand Total</th>
                                        <th>Paid</th>
                                        <th>Due</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for purchase in purchases %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ purchase.purchase_date }}</td>
                                            <td>{{ purchase.supplier.name }}</td>
                                            <td>{{ purchase.warehouse.name }}</td>
                                            <td>
                                                <span class="{% if purchase.status == 'Pending' %}badge badge-warning{% elif purchase.status == 'Received' %}badge badge-success{% elif purchase.status == 'Completed' %}badge badge-primary{% elif purchase.status == 'Canceled' %}badge badge-danger{% endif %}">
                                                    {{ purchase.get_status_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge
                                                    {% if purchase.payment_status == 'Paid' %}
                                                        badge-success
                                                    {% elif purchase.payment_status == 'Pending' %}
                                                        badge-warning
                                                    {% else %}
                                                        badge-danger
                                                    {% endif %}"
                                                >
                                                    {{ purchase.payment_status }}
                                                </span>
                                            </td> <!-- Display Payment Status -->
                                            <td>{{ purchase.grand_total }}</td>
                                            <td>
                                                <ul style="list-style: none; padding: 0; margin: 0;">
                                                    {% for p in payment %}
                                                        {% if p.purchase == purchase %}
                                                            <li>{{ p.amount|floatformat:2 }}</li>
                                                        {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            </td>

                                            <td>
                                                {{ purchase.due_amount|floatformat:2 }}
                                            </td>
                                            <td>
                                                <div class="btn-group dropdown">
                                                    <button class="btn btn-secondary custom-btn-group dropdown-toggle" type="button" id="actionsDropdown{{ purchase.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                        Actions
                                                    </button>
                                                    <div class="dropdown-menu text-black">
                                                        {% if purchase.payment_status != 'Paid' %}
                                                        <a class="dropdown-item action-link  make-payment-link" href="#" data-toggle="modal"  data-action="modal-view-ak" data-target="#makePaymentModal{{ purchase.id }}" data-purchase-id="{{ purchase.id }}">
                                                            Make Payment
                                                        </a>
                                                        {% endif %}
                                                       
                                                        <a class="dropdown-item action-link view-payment-link" data-action="modal-view-payment" data-toggle="modal" data-target="#viewPaymentModal{{ purchase.id }}" href="#" data-purchase-id="{{ purchase.id }}">
                                                            View Payment
                                                        </a>
                                                        
                                                           
                                                           
                                                            <a class="dropdown-item action-link view-purchase-link" href="#" data-toggle="modal" data-action="modal-view" data-target="#viewPurchaseModal{{ purchase.id }}">
                                                                View Purchase
                                                            </a>
                                                            <a class="dropdown-item  action-link view-purchase-link" href="#" data-toggle="modal" data-action="modal-edit" data-target="#editPurchaseModal{{ purchase.id }}">
                                                                Edit Purchase
                                                            </a>

                                                         
                                                            <a class="dropdown-item action-link delete-purchase" data-id="{{ purchase.id }}" data-toggle="modal" data-target="#deletePurchaseModal" href="#">Delete</a>

                                                                                          
                                                        </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>





{% for purchase in purchases %}
<div class="modal fade" id="viewPaymentModal{{ purchase.id }}" tabindex="-1" role="dialog" aria-labelledby="viewPaymentModalModalLabel{{ purchase.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-black" id="viewPaymentModalModalLabel{{ purchase.id }}">View Payment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Display Payment Information Here -->
                <table id="pay-detail-list-view" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Purchase ID</th>
                            <th>Payment Date</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Transaction ID</th>
                            
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ purchase.id }}</td>
                            <td><span id="paymentDate-{{ purchase.id }}"></span></td>
                           <td><span id="amounts-{{ purchase.id }}"></span></td>
                            <td><span id="paymentMethod-{{ purchase.id }}"></span></td>
                            <td><span id="transactionId-{{ purchase.id }}"></span></td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-secondary custom-btn-group dropdown-toggle" type="button" id="actionsDropdown{{ purchase.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Actions
                                    </button>
                                    <div class="dropdown-menu" >
                                        <a class="dropdown-item action-link edit-payment-link" href="#" data-toggle="modal" data-target="#editPaymentModal{{ purchase.id }}" data-purchase-id="{{ purchase.id }}">
                                            Edit Payment
                                        </a>
                                            <a class="dropdown-item action-link  delete-payment" data-id="{{ purchase.id }}" data-toggle="modal" data-target="#deletePaymenteModal" href="#">Delete</a>


                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
             
            </div>
        </div>
    </div>
</div>
{% endfor %}





{% for purchase in purchases %}
  

    <div class="modal fade" id="editPaymentModal{{ purchase.id }}" tabindex="-1" role="dialog" aria-labelledby="editPaymentModalLabel{{ purchase.id }}"  data-backdrop="static" data-keyboard="false" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-black" id="editPaymentModalLabel{{ purchase.id }}">Edit Payment</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Form for editing payment details -->
                    <form class="edit-payment-form" id="editPaymentForm{{ purchase.id }}" data-purchase-id="{{ purchase.id }}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="payment_date">Payment Date</label>
                            <input type="date" class="form-control" name="payment_date">
                        </div>
                        <div class="form-group">
                            <label for="amount">Amount</label>
                            <input type="text" class="form-control" name="amount">
                        </div>
                        <div class="form-group">
                            <label for="payment_method">Payment Method</label>
                            <select class="form-control" name="payment_method">
                                {% for method, display_name in payment_methods %}
                                    <option value="{{ method }}" {% if method == payment.payment_method %}selected{% endif %}>{{ display_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transaction_id">Transaction ID</label>
                            <input type="text" class="form-control" name="transaction_id">
                        </div>
                        <div class="form-group">
                            <label for="card_number">Card Number</label>
                            <input type="text" class="form-control" name="card_number">
                        </div>
                        <button type="submit" class="custom-btn" >Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="deletePaymentModal{{ payment.id }}" tabindex="-1" role="dialog" aria-labelledby="deletePaymentModalLabel{{ payment.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePaymentModalLabel{{ payment.id }}">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this payment (Payment ID: {{ payment.id }})?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePayment{{ payment.id }}" data-payment-id="{{ payment.id }}">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% for purchase in purchases %}
<div class="modal fade" id="makePaymentModal{{ purchase.id }}" tabindex="-1" role="dialog" aria-labelledby="makePaymentModalModalLabel{{ purchase.id }}" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-black" id="makePaymentModalModalLabel{{ purchase.id }}">Make Payment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Purchase Payment Form -->
                <form id="paymentForm{{ purchase.id }}">
                    {% csrf_token %}
                    {% comment %} <input type="hidden" id="payment-purchase-id" name="payment_purchase_id" value="{{ purchase.id}}"> {% endcomment %}
                    <div class="form-group">
                        <label for="payment_date">Payment Date</label>
                        <input type="date" class="form-control" id="make-payment-date-{{ purchase.id }}" name="make_payment_date">
                    </div>
                    <div class="form-group">
                        <label for="grand_total">Received Amount</label>
                        <input type="text" class="form-control" id="grand_total-{{ purchase.id }}" name="grand_total" value="{{ purchase.grand_total }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="number" step="0.01" class="form-control" id="make-payment-amount-{{ purchase.id }}" name="make_payment_amount" value="{{ purchase.due_amount }}" >
                    </div>
                   
                    
                    <div class="form-group">
                        <label for="payment_method">Payment Method:</label>
                        <select id="make-payment-method-{{ purchase.id }}" class="form-control" name="make_payment_method" required>
                            <option value="" disabled selected>Select Payment Method</option>
                            {% for method in payment_methods %}
                            <option value="{{ method.0 }}">{{ method.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transaction_id">Transaction ID</label>
                        <input type="text" class="form-control" id="make-payment-transaction-id-{{ purchase.id }}" name="make_payment_transaction_id">
                    </div>
                    <!-- New Fields -->
                    <div id="card-number-div-{{purchase.id}}" class="card-number-div form-group">
                        <label for="card_number">Card Number</label>
                        <input type="text" class="form-control" id="card_number-{{ purchase.id }}" name="card_number">
                    </div>
                    <div id="account-number-div-{{purchase.id}}" class="account-number-div form-group">
                        <label for="cheque_number">Cheque Number</label>
                        <input type="text" class="form-control" id="cheque_number-{{ purchase.id }}" name="cheque_number">
                    </div>
                    <div id="phone-number-div-{{purchase.id}}" class="phone-number-div form-group">
                        <label for="phone_number">Phone Number</label>
                        <input type="text" class="form-control" id="phone_number" name="phone_number">
                    </div>
                    <div id="sale-note-{{purchase.id}}" class="sale-note form-group">
                        <label for="sale_note">Sale Note</label>
                        <textarea class="form-control" id="sale_note-{{ purchase.id }}" name="sale_note" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="custom-btn submitPayment" id="{{ purchase.id }}">Submit Payment</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Delete Product Confirmation Modal -->


{% for purchase in purchases %}
<div class="modal fade" id="viewPurchaseModal{{ purchase.id }}" tabindex="-1" role="dialog" aria-labelledby="viewPurchaseModalLabel{{ purchase.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content col-lg-12 col-md-12 col-12">
            <div class="modal-header">
                <h5 class="modal-title text-black" id="viewPurchaseModalLabel{{ purchase.id }}">View Purchase</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body w-100">
              
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editPurchaseModal{{ purchase.id }}" tabindex="-1" role="dialog" aria-labelledby="editPurchaseModalLabel{{ purchase.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content my-0">
            <div class="modal-header">
                <h5 class="modal-title text-black" id="editPurchaseModalLabel{{ purchase.id }}">Edit Purchase</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editPurchaseForm-{{purchase.id}}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" id="purchaseId" name="purchase_id" value="{{ purchase.id }}">
                
                    <div class="form-group">
                        <label for="editPurchaseDate-{{purchase.id}}">Purchase Date:</label>
                        <input type="text" class="form-control" id="editPurchaseDate-{{purchase.id}}" name="purchase_date">
                    </div>
                    <div class="form-group">
                        <label for="editWarehouse">Warehouse:</label>
                        <select class="form-control" id="editWarehouse-{{purchase.id}}" name="warehouse">
                    
                            {% for warehouse in warehouses %}
                                <option value="{{ warehouse.id }}" {% if warehouse.id == purchase_data.warehouse_id %}selected{% endif %}>{{ warehouse.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editProduct-{{purchase.id}}">Product:</label>
                        <select class="form-control" id="editProduct-{{purchase.id}}" name="product">
             
                            {% for product in products %}
                                <option value="{{ product.id }}" {% if product.id == purchase_data.product_id %}selected{% endif %}>{{ product.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editInvoiceNumber-{{purchase.id}}">Invoice Number:</label>
                        <input type="text" class="form-control" id="editInvoiceNumber-{{purchase.id}}" name="invoice_number">
                    </div>
                    <div class="form-group">
                        <label for="editTax-{{purchase.id}}">Tax:</label>
                        <select class="form-control" id="editTax-{{purchase.id}}" name="tax">
                            {% for taxes in taxes %}
                                <option value="{{ taxes.id }}" {% if taxes.id == taxes_data.taxes_id %}selected{% endif %}>{{ taxes.rate }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDiscount-{{purchase.id}}">Discount:</label>
                        <input type="number" class="form-control" id="editDiscount-{{purchase.id}}" name="discount">
                        {% comment %} <select class="form-control" id="editDiscount-{{purchase.id}}" name="discount">
                            <!-- Loop through the available discounts and generate options -->
                            {% for discount in discounts %}
                                <option value="{{ discount.id }}">{{ discount.name }} - {{ discount.amount }}%</option>
                            {% endfor %}
                        </select> {% endcomment %}


                    </div>
                    <div class="form-group">
                        <label for="editShipping-{{purchase.id}}">Shipping:</label>
                        <input type="text" class="form-control" id="editShipping-{{purchase.id}}" name="shipping">
                    </div>
                    <div class="form-group">
                        <label for="editStatus-{{purchase.id}}">Status:</label>
                        <select class="form-control" id="editStatus-{{purchase.id}}" name="status">
                            <!-- Include options for selecting the status -->
                            <option value="Pending">Pending</option>
                            <option value="Received">Received</option>
                            <option value="Completed">Completed</option>
                            <option value="Canceled">Canceled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPurchaseNote-{{purchase.id}}">Purchase Note:</label>
                        <textarea class="form-control" id="editPurchaseNote-{{purchase.id}}" name="purchase_note"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editGrandTotal-{{purchase.id}}">Grand Total:</label>
                        <input type="text" class="form-control" id="editGrandTotal-{{purchase.id}}" name="grand_total">
                    </div>
                    <div class="form-group">
                        <label for="editSupplier-{{purchase.id}}">Supplier:</label>
                        <select class="form-control" id="editSupplier-{{purchase.id}}" name="supplier">
                            <!-- Loop through the available suppliers and generate options -->
                            {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Add a button to submit the form -->
                    <button type="submit" class="custom-btn">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}





{% endblock main_content %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
    // Initialize flatpickr for date fields
    flatpickr('.flatpickr', {
        dateFormat: "M. d, Y", // Set the desired date format
        allowInput: true,
    });
</script>
<script>
    $(document).ready(function() {
        $('.delete-purchase').click(function() {
            // Get the purchase ID from the data attribute
            var purchaseId = $(this).data('id');
            
            // Display a SweetAlert2 confirmation dialog
            Swal.fire({
                title: 'Are you sure?',
                text: 'You won\'t be able to revert this!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Send an AJAX request to delete the purchase
                    $.ajax({
                        url: `/delete_purchase/${purchaseId}/`, // Replace with your URL
                        type: 'POST',
                        data: {
                            csrfmiddlewaretoken: '{{ csrf_token }}' // Replace with your CSRF token
                        },
                        success: function(response) {
                            if (response.success) {
                                // Handle a successful delete action
                                // For example, you can remove the deleted item from the list
                                // No need for alert here, as SweetAlert2 provides a built-in success message
                                location.reload(); // Reloading the page as an example
                            } else {
                                // Handle errors
                                Swal.fire('Error', response.message, 'error');
                            }
                        },
                        error: function() {
                            // Handle AJAX errors
                            Swal.fire('Error', 'An error occurred during the delete process.', 'error');
                        }
                    });
                }
            });
        });
    });
</script>

<script>
    var csrf_token = "{{ csrf_token }}";

    $(document).ready(function () {
        $(".make-payment-link").click(function () {
            // Clear any previous input values in the modal
            var purchaseId = $(this).data('purchase-id');
            let paymentMethodoptions = $("#make-payment-method-" + purchaseId)
            console.log('purchase_id make: ', purchaseId);
            $("#make-payment-date-" + purchaseId).val("");
            paymentMethodoptions.val("");
            $("#make-payment-transaction-id-" + purchaseId).val("");
            $("#card_number-" + purchaseId).val("");
           
            $("#sale_note").val("");

            // Get the purchase ID from the data attribute
            

            // Set the purchase ID in a hidden input field in the modal
            $("#payment-purchase-id").val(purchaseId);

            // Open the payment modal
            
            $("#makePaymentModal" + purchaseId).modal("show");

            // Populate the payment method dropdown with options
            const paymentMethodSelect = $("#make-payment-method-" + purchaseId);
            paymentMethodSelect.empty(); // Clear existing options

            let cardDiv = $("#card-number-div-" + purchaseId)
            console.log('cardDiv: ', cardDiv);
            $("#card-number-div-" + purchaseId).hide();
            $("#account-number-div-" + purchaseId).hide();
            $("#phone-number-div-" + purchaseId).hide();
            //$("#card-number-div-" + purchaseId, "#account-number-div-" + purchaseId, "#phone-number-div-" + purchaseId).hide();
            console.log('test note: card-number-div', purchaseId)

            // Event listener for changes in the payment method dropdown
            $("#make-payment-method-" + purchaseId).change(function() {
                // Hide all payment method related divs
                $("#card-number-div-" + purchaseId).hide();
                $("#account-number-div-" + purchaseId).hide();
                $("#phone-number-div-" + purchaseId).hide();
    
                // Get the selected payment method
                var selectedMethod = $(this).val();
    
                // Show the corresponding div based on the selected payment method
                if (selectedMethod === "Card") {
                    $("#card-number-div-" + purchaseId).show();
                } else if (selectedMethod === "Bank") {
                    $("#account-number-div-" + purchaseId).show();
                } else if (selectedMethod === "Others") {
                    $("#phone-number-div-" + purchaseId).show();
                }
            });

            // Make an AJAX request to fetch payment data
            fetch('/get_payment_data/' + purchaseId, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate the modal with the payment data
                    console.log('data received');
                    console.log('data.payment_data.payment_date: ', data.payment_data.payment_date);

                    $('#make-payment-date-' + purchaseId).val(data.payment_data.payment_date);
                    $("#make-payment-method-" + purchaseId).val(data.payment_data.payment_method);
                    $('#make-payment-transaction-id-' + purchaseId).val(data.payment_data.transaction_id);
                } else {
                    // Handle any errors
                    alert('Failed to load payment data: ' + data.message);
                }
            })
            .catch(error => {
                // Handle any errors
                alert('Failed to load payment data.');
            });

            // Add payment method options
            const paymentMethods = [
                ['Card', 'Card'],
                ['Cash', 'Cash'],
                ['Bank', 'Bank'],
            ];

            for (const method of paymentMethods) {
                paymentMethodSelect.append(new Option(method[1], method[0]));
            }
        });

        // Handle the "Submit Payment" button click
        $(document).on('click', '.submitPayment', function () {
            // Get the values from the input fields
            var purchaseId = $(this).attr('id').split('-').pop();
            var payment_date = $("#make-payment-date-" + purchaseId).val();
            var amount = $("#make-payment-amount-" + purchaseId).val();
            var payment_method = $("#make-payment-method-" + purchaseId).val();
            var transaction_id = $("#make-payment-transaction-id-" + purchaseId).val();
            var card_number = $("#card_number-" + purchaseId).val();
            var cheque_number=$("#cheque_number-" + purchaseId).val();

            var sale_note = $("#sale_note-" + purchaseId).val();
            console.log('purchase id inventory: ', purchaseId);

            // Prepare the data to send
            var requestData = {
                payment_date: payment_date,
                amount: amount,
                payment_method: payment_method,
                transaction_id: transaction_id,
                card_number: card_number,
                cheque_number:cheque_number,
                sale_note: sale_note,
                csrfmiddlewaretoken: csrf_token
            };

            console.log('purchaseId: ', purchaseId);
            console.log('payment_date: ', payment_date);
            console.log('amount: ', amount);
            console.log('payment_method: ', payment_method);
            console.log('transaction_id: ', transaction_id);
            console.log('card_number: ', card_number);
            console.log('sale_note: ', sale_note);
            console.log('cheque_number: ', cheque_number);

            // Make an AJAX request to submit the payment
            fetch(`/make_payment_inventory/${purchaseId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token,
                },
                body: JSON.stringify(requestData),
            })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    // Payment was successful, close the modal
                    $("#makePaymentModal" + purchaseId).modal("hide");
                    // Optionally, you can display a success message or update the UI
                    alert(response.message);
                    window.location.href = "{% url 'purchase_list' %}";
                } else {
                    // Payment failed, you can display an error message
                    alert(response.message);
                }
            })
            .catch(error => {
                console.error("Error submitting payment:", error);
                // Handle AJAX error, if any
                alert("An error occurred while processing your request.");
            });
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('#paydetaillist').DataTable({
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'copy',
                    text: '<i class="fa-solid fa-copy fa-lg"></i>',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6,7] // Specify which columns to include
                    }
                },
                {
                    extend: 'csv',
                    text: '<i class="fa-solid fa-file-csv fa-lg"></i>',
                    filename: 'Purchases List', // Specify the filename
                    extension: '.csv',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6,7] // Specify which columns to include
                    },
                    fieldSeparator: ',', // Specify the field separator (comma)
                    fieldBoundary: '"' // Specify the field boundary character
                },
                {
                    extend: 'excel',
                    text: '<i class="fas fa-file-excel fa-lg"></i>',
                    filename: 'Purchase List', // Specify the filename
                    extension: '.xlsx',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6,7] // Specify which columns to include
                    }
                },
                {
                    extend: 'pdf',
                    text: '<i class="fa-solid fa-file-pdf"></i>',
                    filename: 'Purchase List', // Specify the filename
                    extension: '.pdf',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6,7] // Specify which columns to include
                    }
                },
                'print'
            ],
            initComplete: function () {
                console.log("DataTables initialized!"); // Debugging statement
            }
        });
    });
</script>
{% comment %} <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Add a click event handler for the "View Payment" buttons
        document.querySelectorAll('a[data-toggle="modal"]').forEach(function(button) {
            button.addEventListener('click', function() {
                var targetModalId = this.getAttribute('data-target'); // Get the ID of the target modal
                var purchaseId = targetModalId.replace('#viewPaymentModal', ''); // Extract the purchase ID from modal ID
    
                // Make an AJAX request to fetch payment data
                fetch('/get_payment_data/' + purchaseId) // Replace with the actual URL to your Django view
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Populate the modal with the payment data
                            document.getElementById('paymentDate').textContent = 'Payment Date: ' + data.payment_data.payment_date;
                            document.getElementById('amount').textContent = 'Amount: ' + data.payment_data.amount;
                            document.getElementById('paymentMethod').textContent = 'Payment Method: ' + data.payment_data.payment_method;
                            document.getElementById('transactionId').textContent = 'Transaction ID: ' + data.payment_data.transaction_id;
    
                            // Open the target modal using Bootstrap modal method
                            $(targetModalId).modal('show');
                        } else {
                            // Handle any errors
                            alert('Failed to load payment data: ' + data.message);
                        }
                    })
                    .catch(error => {
                        // Handle any errors
                        alert('Failed to load payment data.');
                    });
            });
        });
    });
    </script> {% endcomment %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Add a click event handler for the "View Payment" buttons
            document.querySelectorAll('.view-payment-link').forEach(function (button) {
                button.addEventListener('click', function () {
                    var purchaseId = this.getAttribute('data-purchase-id');
    
                    // Make an AJAX request to fetch payment data
                    fetch(`/get_payment_data/${purchaseId}/`, {
                        method: 'GET'
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Populate the modal with the payment data
                                document.getElementById(`paymentDate-${purchaseId}`).textContent = data.payment_data.payment_date;
                                document.getElementById(`amounts-${purchaseId}`).textContent = data.payment_data.amount;
                                document.getElementById(`paymentMethod-${purchaseId}`).textContent = data.payment_data.payment_method;
                                document.getElementById(`transactionId-${purchaseId}`).textContent = data.payment_data.transaction_id;
    
                                // Show the modal
                                $(`#viewPaymentModal${purchaseId}`).modal('show');
                            } else {
                                // Handle any errors
                                alert('Failed to load payment data: ' + data.message);
                            }
                        })
                        .catch(error => {
                            // Handle any errors
                            alert('Failed to load payment data.');
                        });
                });
            });
        });
    </script>
    <script>
        $(document).ready(function() {

            $('.delete-payment').click(function() {
                $('#viewPaymentModal').hide();
                // Get the purchase ID from the data attribute
                var paymentId = $(this).data('id');
               
                
                // Display a SweetAlert2 confirmation dialog
                Swal.fire({
                    title: 'Are you sure?',
                    text: 'You won\'t be able to revert this!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Send an AJAX request to delete the purchase
                        $.ajax({
                            url: `/delete_payment/${paymentpuId}/`, // Replace with your URL
                            type: 'POST',
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}' // Replace with your CSRF token
                            },
                            success: function(response) {
                                if (response.success) {
                                    // Handle a successful delete action
                                    // For example, you can remove the deleted item from the list
                                    // No need for alert here, as SweetAlert2 provides a built-in success message
                                    location.reload(); // Reloading the page as an example
                                } else {
                                    // Handle errors
                                    Swal.fire('Error', response.message, 'error');
                                }
                            },
                            error: function() {
                                // Handle AJAX errors
                                Swal.fire('Error', 'An error occurred during the delete process.', 'error');
                            }
                        });
                    }
                });
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.edit-payment-link').forEach(function (link) {
                link.addEventListener('click', function (event) {
                    event.preventDefault();
                    var purchaseId = this.getAttribute('data-purchase-id');
                    $('#viewPaymentModal' + purchaseId).hide();
    
                    fetch(`/edit_payment/${purchaseId}/`)
                        .then(function (response) {
                            if (!response.ok) {
                                throw new Error(`Network response was not ok. Status: ${response.status}`);
                            }
    
                            // Check if the response has JSON content type
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error('Response is not in JSON format');
                            }
    
                            return response.json();
                        })
                        .then(function (data) {
                            console.log('Success:', data);
    
                            // Check if the response is empty
                            if (Object.keys(data).length === 0 && data.constructor === Object) {
                                alert('No data found for this purchase.');
                            } else {
                                populateFormFields(data.payment_data, purchaseId);
                                $('#editPaymentModal' + purchaseId).modal('show');
                            }
                        })
                        .catch(function (error) {
                            console.error('Error:', error);
    
                            if (error.message === 'Response is not in JSON format') {
                                alert('Unexpected response format. Please try again.');
                            } else {
                                alert('Error fetching payment data. Please try again.');
                            }
                        });
                });
            });
    
            document.querySelectorAll('.edit-payment-form').forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    var purchaseId = this.getAttribute('data-purchase-id');
                    var formData = new FormData(form);
    
                    formData.append('csrfmiddlewaretoken', document.querySelector('input[name="csrfmiddlewaretoken"]').value);
    
                    fetch(`/edit_payment/${purchaseId}/`, {
                        method: 'POST',
                        body: JSON.stringify(Object.fromEntries(formData)),
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        console.log('Success:', data);
                        $('#editPaymentModal' + purchaseId).modal('hide');
                        location.reload();
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('Error updating payment. Please try again.');
                    });
                });
            });
    
            function populateFormFields(paymentData, purchaseId) {
                var form = document.getElementById('editPaymentForm' + purchaseId);
    
                form.querySelector('[name="payment_date"]').value = paymentData.payment_date;
                form.querySelector('[name="amount"]').value = paymentData.amount;
                form.querySelector('[name="payment_method"]').value = paymentData.payment_method;
                form.querySelector('[name="transaction_id"]').value = paymentData.transaction_id;
                form.querySelector('[name="card_number"]').value = paymentData.card_number;
            }
        });
    </script>


    <script>
        console.log('Script is loaded.');
        document.addEventListener("DOMContentLoaded", function () {
            // Add a click event handler for the "View Purchase" buttons
            document.querySelectorAll('a[data-action="modal-view"]').forEach(function (button) {
                button.addEventListener('click', function () {
                    var targetModalId = this.getAttribute('data-target'); // Get the ID of the target modal
                    var purchaseId = targetModalId.replace('#viewPurchaseModal', ''); // Extract the purchase ID from modal ID
    
                    // Make an AJAX request to fetch purchase data
                    fetch('/view_purchase/' + purchaseId, {
                        method: 'GET'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Network response was not ok. Status: ${response.status}`);
                            }
    
                            // Check if the response has JSON content type
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error('Response is not in JSON format');
                            }
    
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                // Populate the modal with the purchase data
                                var modalContent = document.querySelector(targetModalId + ' .modal-body');
                                modalContent.innerHTML = ''; // Clear existing content
    
                                var table = document.createElement('table');
                                table.className = 'table table-bordered';
    
                                var thead = document.createElement('thead');
                                var tbody = document.createElement('tbody');
    
                                // Create table header row
                                var headerRow = document.createElement('tr');
                                for (var field in data.purchase_data) {
                                    var th = document.createElement('th');
                                    th.textContent = field.replace(/_/g, ' ').toUpperCase();
                                    headerRow.appendChild(th);
                                }
                                thead.appendChild(headerRow);
    
                                // Create table body row
                                var bodyRow = document.createElement('tr');
                                for (var field in data.purchase_data) {
                                    var td = document.createElement('td');
                                    td.textContent = data.purchase_data[field];
                                    bodyRow.appendChild(td);
                                }
                                tbody.appendChild(bodyRow);
    
                                // Append thead and tbody to the table
                                table.appendChild(thead);
                                table.appendChild(tbody);
    
                                // Append the table to the modal content
                                modalContent.appendChild(table);
    
                                // Open the target modal using Bootstrap modal method
                                $(targetModalId).modal('show');
                            } else {
                                // Handle any errors
                                alert('Failed to load purchase data: ' + data.message);
                            }
                        })
                        .catch(error => {
                            // Handle any errors
                            console.error('Error:', error);
    
                            if (error.message === 'Response is not in JSON format') {
                                alert('Unexpected response format. Please try again.');
                            } else {
                                alert('Failed to load purchase data. Please try again.');
                            }
                        });
                });
            });
    
            // Add a click event handler for the "Close" buttons inside the modals
            document.querySelectorAll('button[id^="viewPurchaseModalCloseButton"]').forEach(function (closeButton) {
                closeButton.addEventListener('click', function () {
                    // Close the modal
                    var targetModalId = closeButton.closest('.modal').id;
                    $(targetModalId).modal('hide');
                    window.location.href = "{% url 'purchase_list' %}";
                });
            });
    
            // Add a click event handler for the "x" (cross) icon in the modal's header
            document.querySelectorAll('button.close[data-dismiss="modal"]').forEach(function (closeIcon) {
                closeIcon.addEventListener('click', function () {
                    // Close the modal
                    var targetModalId = closeIcon.closest('.modal').id;
                    $(targetModalId).modal('hide');
                    window.location.href = "{% url 'purchase_list' %}";
                });
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Add a click event handler for the "Edit Purchase" buttons
            document.querySelectorAll('a[data-action="modal-edit"]').forEach(function(button) {
                button.addEventListener('click', function() {
                    var targetModalId = this.getAttribute('data-target'); // Get the ID of the target edit modal
                    var purchaseId = targetModalId.replace('#editPurchaseModal', ''); // Extract the purchase ID from modal ID
    
                    // Make an AJAX request to fetch purchase data for editing
                    fetch('/edit_purchase/' + purchaseId, {
                        method: 'GET'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Populate the edit modal form fields with the purchase data
                            document.getElementById('editPurchaseDate-' + purchaseId).value = data.purchase_data.purchase_date;
                            document.getElementById('editWarehouse-' + purchaseId).value = data.purchase_data.warehouse_id;
                            document.getElementById('editProduct-' + purchaseId).value = data.purchase_data.product_id;
                            document.getElementById('editInvoiceNumber-' + purchaseId).value = data.purchase_data.invoice_number;
                            document.getElementById('editTax-' + purchaseId).value = data.purchase_data.tax_id;
                            document.getElementById('editDiscount-' + purchaseId).value = data.purchase_data.discount;
                            document.getElementById('editShipping-' + purchaseId).value = data.purchase_data.shipping;
                            document.getElementById('editStatus-' + purchaseId).value = data.purchase_data.status;
                            document.getElementById('editGrandTotal-' + purchaseId).value = data.purchase_data.grand_total;
                            document.getElementById('editPurchaseNote-' + purchaseId).value = data.purchase_data.purchase_note;
                            // Include code to populate other fields as needed
    
                            // Open the target edit modal using Bootstrap modal method
                            $(targetModalId).modal('show');

                            $('#editPurchaseForm-' + purchaseId).submit(function(e){
                                event.preventDefault();

                                data = {}
                                //var formData = $(this).serialize();
                                //var form = $('#editPurchaseForm-' + purchaseId)
                                var formData = $(this).serializeArray();
                                formData.forEach(function(value, key){
                                    console.log(key, value);
                                });

                                formData.forEach(function (entry) {
                                    data[entry.name] = entry.value;
                                });

                                console.log('data: ', data)

                                fetch(`/edit_purchase/${purchaseId}/`, {
                                    method: 'POST',
                                    body: JSON.stringify(data),
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'x-CSRFToken': '{{csrf_token}}'
                                    },
                                })
                                .then(function (response) {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.json();
                                })
                                .then(function (data) {
                                    console.log('Success:', data);
                                    $('#editPurchaseForm-' + purchaseId).modal('hide');
                                    //location.reload();
                                })
                                .catch(function (error) {
                                    console.error('Error:', error);
                                    alert('Error updating payment. Please try again.');
                                });

                            })
                        }
                        else {
                            // Handle any errors
                            alert('Failed to load purchase data for editing: ' + data.message);
                        }
                    })
                    .catch(error => {
                        // Handle any errors
                        alert('Failed to load purchase data for editing.');
                    });
                });
            });
    
            // Add a click event handler for the close button in modals
            document.querySelectorAll('button[id^="editPurchaseModalCloseButton"]').forEach(function(closeButton) {
                closeButton.addEventListener('click', function() {
                    // Close the edit modal
                    var targetModalId = closeButton.closest('.modal').id;
                    $(targetModalId).modal('hide');
                    window.location.href = "{% url 'purchase_list' %}";
                });
            });
        
            // Add a click event handler for the "x" (cross) icon in the modal's header
            document.querySelectorAll('button.close[data-dismiss="modal"]').forEach(function(closeIcon) {
                closeIcon.addEventListener('click', function() {
                    // Close the edit modal
                    var targetModalId = closeIcon.closest('.modal').id;
                    $(targetModalId).modal('hide');
                    window.location.href = "{% url 'purchase_list' %}";
                });
            });
        });// Add a click event handler for clicking outside the modal
          
     
    </script>


    
{% endblock custom_js %}